<span class="s1">RSYNC数据备份</span>

<span class="s2">RSYNC=Remote Sync 远程同步 高效，一定要结合shell</span>

<span class="s2">官方网站：</span>[<span class="s3">https://rsync.samba.org/</span>](https://rsync.samba.org/)

<span class="s2">Author： Andrew Tridgell, Wayne Davison, and others</span>

<span class="s2"> Andrew Tridgell是Samba项目的领导者和主要开发人员，同时还在参与开发rsync、Linux Kernel。</span>

<span class="s2">\#</span><a name="OLE_LINK1"></a><a name="OLE_LINK2"></a><a name="OLE_LINK4"><span class="s2">rsync </span><span class="s4">--</span><span class="s2">version</span></a><span class="s2"> </span><span class="s5">\#查看rsync版本，可以看到相关作者相信</span>

<span class="s2">rsync version </span><span class="s6">3</span><span class="s4">.</span><span class="s6">0</span><span class="s4">.</span><span class="s6">6</span><span class="s2"> protocol version </span><span class="s6">30</span>

<span class="s2">Copyright </span><span class="s4">(</span><span class="s2">C</span><span class="s4">)</span><span class="s6">1996</span><span class="s4">-</span><span class="s6">2009</span><span class="s2"> by </span><span class="s7">Andrew Tridgell, Wayne Davison, and others.</span>

<span class="s2">Web site</span><span class="s4">:</span><span class="s2"> http://rsync.samba.org/</span>

<span class="s2">与SCP的比较：scp=无法备份大量数据，类似windows的复制</span>

<span class="s2"> rsync=边复制 ，边统计，边比较</span>

<span class="s1">Rysnc特性和优点</span>

<span class="s2">可以镜像保存整个目录树和文件系统。</span>

<span class="s2">可以很容易做到保持原来文件的权限、时间、软硬链接等等。</span>

<span class="s2">无须特殊权限即可安装。</span>

<span class="s2">快速：第一次同步时 rsync 会复制全部内容，但在下一次只传输修改过的文件。</span>

<span class="s2">压缩传输：rsync 在传输数据的过程中可以实行压缩及解压缩操作，因此可以使用更少的带宽。</span>

<span class="s2">安全：可以使用scp、ssh等方式来传输文件</span>

<span class="s2">支持匿名传输，以方便进行网站镜象。</span>

<span class="s2">选择性保持：符号连接，硬链接，文件属性，权限，时间等</span>

<span class="s1">运行模式和端口</span>

<span class="s2">采用C/S模式（客户端/服务器模式）\[ 就是一个点到点的传输，直接使用rsync命令 \]</span>

<span class="s2">端口873</span>

<span class="s1">发起端和备份源</span>

<span class="s2">四个名词的解释：</span>

<span class="s2">发起端：负责发起rsync同步操作的客户机叫做发起端，通知服务器我要备份你的数据 </span><a name="OLE_LINK8"></a><a name="OLE_LINK9"></a><a name="OLE_LINK10"><span class="s2"> </span><span class="s2"> </span><span class="s6">【可以 理解成是备份存储服务器，存储数据的机器】</span></a><span class="s6"> </span>

<span class="s2">备份源：负责相应来自客户机rsync同步操作的服务器备份源，需要备份的服务器 </span><a name="OLE_LINK5"></a><a name="OLE_LINK6"></a><a name="OLE_LINK7"><span class="s6">【可以理解成是常见的web服务器和数据库服务器】</span></a>

<span class="s2">服务端：运行rsyncd服务，一般来说，需要备份的服务器 </span><span class="s6">【可以理解成是常见的web服务器和数据库服务器】</span>

<span class="s2">客户端：存放备份数据 </span><span class="s6">【可以 理解成是备份存储服务器，存储数据的机器】</span>

<span class="s1">数据同步方式</span>

<span class="s2">推push：一台主机负责把数据传送给其他主机，服务器开销很大，比较适合后端服务器少的情况</span>

<span class="s2">拉pull：所有主机定时去找一主机拉数据，可能就会导致数据缓慢</span>

<span class="s7">推：目的主机配置为rsync服务器，源主机周期性的使用rsync命令把要同步的目录推过去（需要备份的机器是客户端，存储备份的机器是服务端）</span>

<span class="s7">拉：源主机配置为rsync服务器，目的主机周期性的使用rsync命令把要同步的目录拉过来（需要备份的机器是服务端，存储备份的机器是客户端）</span>

<span class="s2">两种方案，rsync都有对应的命令来实现</span>

![](http://alibeibei.oss-cn-shanghai.aliyuncs.com/images/f23bbb53-c137-4f66-b53f-bef0b3ce2197.png)

<span class="s1">Xinetd管理Rsync工作原理</span>

![](http://alibeibei.oss-cn-shanghai.aliyuncs.com/images/15cd7041-e5a2-4c7d-8f5b-da52a946d313.png)

<span class="s2"> 使用rsync来同步是先通过xinetd监听873号端口，如果rsync进来的是873号端口，那么xinetd就会通知它所管辖的rsync服务来做回应，接下来就是rsync俩服务于之间的通讯</span>

<span class="s1">Rsync服务安装</span>

<span class="s2"> 实验拓扑：</span>

<span class="s2">XueGod63（源主机192.168.0.63）===XueGod64（目标主机 192.168.0.64）</span>

<span class="s2">Rsync服务依赖Xinetd，是使用超级服务来管理的</span>

<span class="s2">需要在目标机器上安装rsync服务端</span>

<span class="s2"> \[root@XueGod64 ~\]#</span><a name="OLE_LINK13"></a><a name="OLE_LINK14"></a><a name="OLE_LINK15"></a><a name="OLE_LINK16"></a><a name="OLE_LINK17"><span class="s2"> </span></a><a name="OLE_LINK11"></a><a name="OLE_LINK12"><span class="s2">yum -y install xinetd rsync</span></a>

<span class="s2"> \[root@XueGod64 ~\]# </span><a name="OLE_LINK18"></a><a name="OLE_LINK19"><span class="s2">rsync --</span></a><a name="OLE_LINK60"></a><a name="OLE_LINK61"></a><a name="OLE_LINK62"><span class="s2">daemon</span></a>

<span class="s2">\[root@xuegod64 ~\]# netstat -antup | grep 873</span>

<span class="s2">tcp 0 0 0.0.0.0:873 0.0.0.0:\* LISTEN 2056/rsync </span>

<span class="s2">tcp6 0 0 :::873 :::\* LISTEN 2056/rsync</span>

<span class="s1">Rsync命令</span>

<span class="s2"> rsync命令和scp命令很相似</span>

<span class="s7">-a, --archive archive mode 权限保存模式,相当于 -rlptgoD 参数，存档，递归，保持属性等</span>

<span class="s2">-r, --recursive 复制所有下面的资料，递归处理</span>

<span class="s2">-p, --perms 保留档案权限 ，文件原有属性</span>

<span class="s2">-t, --times 保留时间点，文件原有时间</span>

<span class="s2">-g, --group 保留原有属组</span>

<span class="s2">-o, --owner 保留档案所有者(root only)</span>

<span class="s2">-D, --devices 保留device资讯(root only)</span>

<span class="s2">-l, --links 复制所有的连接 ，拷贝连接文件</span>

<span class="s7">-z, --compress 压缩模式, 当资料在传送到目的端进行档案压缩.</span>

<span class="s2">-H, --hard-links 保留硬链接文件</span>

<span class="s2">-A, --acls 保留ACL属性文件，需要配合--perms</span>

<span class="s2">-P,-P参数和 --partial --progress 相同.只是为了把参数简单化,表示传进度</span>

<span class="s2">--version， 输出rsync版本</span>

<span class="s7">-v , --verbose 复杂的输出信息</span>

<span class="s2">-u, --update 仅仅进行更新，也就是跳过已经存在的目标位置，并且文件时间要晚于要备份的文件，不覆盖新的文件</span>

<span class="s2">--port=PORT， 定义rsyncd(daemon)要运行的port(预设为tcp 873)</span>

<span class="s6">--delete， 删除那些目标位置有的文件而备份源没有的文件</span>

<span class="s6">--password-file=FILE ，从 FILE 中得到密码</span>

<span class="s2">--bwlimit=KBPS， 限制 I/O 带宽</span>

<span class="s2">--filter “-filename”，需要过滤的文件</span>

<span class="s2">--exclude=filname，需要过滤的文件</span>

<span class="s2">--progress，显示备份过程</span>

<span class="s7">常用的 -avz</span>

<span class="s7">补充下：如果传输的特别大的文件，就不要用z 参数，因为压缩和解压比较耗时</span>

<span class="s1">使用rsync备份数据</span>

<span class="s2">对XueGod63网站根目录的/var/www/html目录备份到XueGod64的/web-back</span>

<span class="s2">源服务器:XueGod63 </span>

<span class="s2">目标服务器:XueGod64 </span>

<span class="s1">建立测试用户</span>

<span class="s2"> \[root@XueGod64 ~\]#</span><a name="OLE_LINK22"></a><a name="OLE_LINK23"></a><a name="OLE_LINK24"></a><a name="OLE_LINK25"></a><a name="OLE_LINK26"></a><a name="OLE_LINK27"><span class="s2"> </span></a><a name="OLE_LINK28"></a><a name="OLE_LINK29"></a><a name="OLE_LINK30"><span class="s2">useradd rget1 </span><span class="s2">;</span><span class="s2"> echo rget1:123456 | chpasswd</span></a>

<span class="s2"> \[root@XueGod63 ~\]# useradd rget1 ; echo rget1:123456 | chpasswd</span>

<span class="s2"> //测试用户，rget1用于下载</span>

<span class="s1">对目录赋予ACL权限</span>

<span class="s8">\[root@xuegod63 ~\]#</span><a name="OLE_LINK31"></a><a name="OLE_LINK32"></a><a name="OLE_LINK33"><span class="s8"> mkdir /var/www/html/ -p</span></a>

<span class="s2"> \[root@XueGod63 ~\]# </span><a name="OLE_LINK34"></a><a name="OLE_LINK35"><span class="s2">setfacl -R -m user:rget1:rwx /var/www/html/ </span></a><span class="s2"> //设置rget1的权限</span>

<span class="s2">\[root@XueGod63~\]#</span><a name="OLE_LINK36"></a><a name="OLE_LINK37"><span class="s2"> setfacl -R -m default:rget1:rwx /var/www/html/</span></a>

<span class="s2">\[root@XueGod63 ~\]#</span><a name="OLE_LINK38"></a><a name="OLE_LINK39"><span class="s2"> getfacl /var/www/html</span></a>

<span class="s2">getfacl</span><span class="s4">:</span><span class="s2"> Removing leading </span><span class="s9">'/'</span><span class="s2"> from absolute path names</span>

<span class="s5">\# file: var/www/html</span>

<span class="s5">\# owner: root</span>

<span class="s5">\# group: root</span>

<span class="s2">user</span><span class="s4">::</span><span class="s2">rwx</span>

<span class="s7">user:rget1:rwx</span>

<span class="s2">group</span><span class="s4">::</span><span class="s2">r-x</span>

<span class="s2">mask</span><span class="s4">::</span><span class="s2">rwx</span>

<span class="s2">other</span><span class="s4">::</span><span class="s2">r-x</span>

<span class="s2">default</span><span class="s4">:</span><span class="s2">user</span><span class="s4">::</span><span class="s2">rwx</span>

<span class="s7">default:user:rget1:rwx</span>

<span class="s2">default</span><span class="s4">:</span><span class="s2">group</span><span class="s4">::</span><span class="s2">r-x</span>

<span class="s2">default</span><span class="s4">:</span><span class="s2">mask</span><span class="s4">::</span><span class="s2">rwx</span>

<span class="s2">default</span><span class="s4">:</span><span class="s2">other</span><span class="s4">::</span><span class="s2">r-x</span>

<span class="s2"> </span>

<span class="s1">创建测试数据</span>

<span class="s2"> \[root@XueGod63 ~\]#</span><a name="OLE_LINK40"></a><a name="OLE_LINK41"></a><a name="OLE_LINK42"><span class="s2"> </span></a><a name="OLE_LINK43"></a><a name="OLE_LINK44"></a><a name="OLE_LINK45"><span class="s2">cp -r /boot/\* /var/www/html/ </span></a><span class="s2"> //boot目录下的所有数据作为测试数据</span>

<span class="s2">\[root@xuegod64 ~\]#</span><a name="OLE_LINK46"></a><a name="OLE_LINK47"></a><a name="OLE_LINK48"><span class="s2"> mkdir /web-back</span></a>

<span class="s2">\[root@xuegod64 ~\]#</span><a name="OLE_LINK49"></a><a name="OLE_LINK50"></a><a name="OLE_LINK51"><span class="s2"> chown rget1:rget1 -R /web-back/</span></a>

<span class="s2"> \[root@XueGod63 ~\]# </span><a name="OLE_LINK52"></a><a name="OLE_LINK53"><span class="s7">rsync -avz --delete /var/www/html/ rget1@192.168.0.64: /web-back/</span></a>

<span class="s7">非系统用户备份数据</span>

<span class="s7">使用系统配置文件</span><a name="OLE_LINK54"></a><a name="OLE_LINK55"></a><a name="OLE_LINK56"></a><a name="OLE_LINK57"></a><a name="OLE_LINK58"></a><a name="OLE_LINK59"><span class="s7">/etc/rsyncd.conf</span></a><span class="s7">来备份数据，创建备份账户，最后把rsync以deamon方式运行</span>

<span class="s1">rsyncd.conf配置文件</span>

<span class="s2">配置文件分为两部分：全局参数，模块参数</span>

<span class="s2">全局参数：对rsync服务器生效，如果模块参数和全局参数冲突，冲突的地方模块参数生效</span>

<span class="s2">模块参数：定义需要通过rsync输出的目录定义的参数</span>

<span class="s2">常见的全局参数：</span>

<span class="s2">port </span><span class="s5">\#→指定后台程序使用的端口号，默认为873。</span>

<span class="s2">uid </span><span class="s5">\#→该选项指定当该模块传输文件时守护进程应该具有的uid，配合gid选项使用可以确定哪些可以访问怎么样的文件权限，默认值是" nobody"。</span>

<span class="s2">gid </span><span class="s5">\#→该选项指定当该模块传输文件时守护进程应该具有的gid。默认值为" nobody"。</span>

<span class="s2">max connections </span><span class="s5">\#→指定该模块的最大并发连接数量以保护服务器，超过限制的连接请求将被告知随后再试。默认值是0，也就是没有限制。</span>

<span class="s2">lock file </span><span class="s5">\#→指定支持max connections参数的锁文件，默认值是/var/run/rsyncd.lock。</span>

<span class="s2">motd file </span><span class="s5">\#→" motd file"参数用来指定一个消息文件，当客户连接服务器时该文件的内容显示给客户，默认</span>

<span class="s5">是没有motd文件的。</span>

<span class="s2">log file </span><span class="s5">\#→" log file"指定rsync的日志文件，而不将日志发送给syslog。</span>

<span class="s2">pid file </span><span class="s5">\#→指定rsync的pid文件，通常指定为“/var/run/rsyncd.pid”，存放进程ID的文件位置。</span>

<span class="s2">hosts allow </span><span class="s4">=</span><span class="s2"> </span><span class="s5">\#→单个IP地址或网络地址 //允许访问的客户机地址</span>

<span class="s2">常见的模块参数：主要是定义服务器哪个要被同步输出，其格式必须为“ \[ 共享模块名 \]” 形式，这个名字就是在 rsync 客户端看到的名字，其实很像 Samba 服务器提供的共享名。而服务器真正同步的数据是通过 path 来指定的。</span>

<span class="s2">Comment </span><span class="s5">\#→给模块指定一个描述，该描述连同模块名在客户连接得到模块列表时显示给客户。默认没有描述定义。</span>

<span class="s6">Path </span><span class="s2"> </span><span class="s5">\#→指定该模块的供备份的目录树路径，该参数是必须指定的。</span>

<span class="s10">read</span><span class="s2"> only </span><span class="s5">\#→yes为只允许下载，no为可以下载和上传文件到服务器</span>

<span class="s6">auth users</span><span class="s2"> </span><span class="s5">\#→该选项指定由空格或逗号分隔的用户名列表，只有这些用户才允许连接该模块。这里的用户和系统用户没有任何关系。如果" auth users"被设置，那么客户端发出对该模块的连接请求以后会被rsync请求challenged进行验证身份这里使用的challenge/response认证协议。用户的名和密码以明文方式存放在" secrets file"选项指定的文件中。默认情况下无需密码就可以连接模块(也就是匿名方式)。</span>

<span class="s6">secrets file </span><span class="s2"> </span><span class="s5">\#→该选项指定一个包含定义用户名:密码对的文件。只有在" auth users"被定义时，该文件才有作用。文件每行包含一个username:passwd对。一般来说密码最好不要超过8个字符。没有默认的secures file名，注意：该文件的权限一定要是600，否则客户端将不能连接服务器。</span>

<span class="s2">hosts allow </span><span class="s5">\#→指定哪些IP的客户允许连接该模块。定义可以是以下形式：</span>

<span class="s2"> 单个IP地址，例如：</span><span class="s6">192</span><span class="s4">.</span><span class="s6">167</span><span class="s4">.</span><span class="s6">0</span><span class="s4">.</span><span class="s6">1</span><span class="s2">，多个IP或网段需要用空格隔开，</span>

<span class="s2"> 整个网段，例如：</span><span class="s6">192</span><span class="s4">.</span><span class="s6">168</span><span class="s4">.</span><span class="s6">0</span><span class="s4">.</span><span class="s6">0</span><span class="s4">/</span><span class="s6">24</span><span class="s2">，也可以是</span><span class="s6">192</span><span class="s4">.</span><span class="s6">168</span><span class="s4">.</span><span class="s6">0</span><span class="s4">.</span><span class="s6">0</span><span class="s4">/</span><span class="s6">255</span><span class="s4">.</span><span class="s6">255</span><span class="s4">.</span><span class="s6">255</span><span class="s4">.</span><span class="s6">0</span>

<span class="s2">“</span><span class="s4">\*</span><span class="s2">”则表示所有，默认是允许所有主机连接。</span>

<span class="s2">hosts deny </span><span class="s5">\#→指定不允许连接rsync服务器的机器，可以使用hosts allow的定义方式来进行定义。默认是没有hosts deny定义。</span>

<span class="s2">list </span><span class="s5">\#→该选项设定当客户请求可以使用的模块列表时，该模块是否应该被列出。如果设置该选项为false，</span>

<span class="s5">可以创建隐藏的模块。默认值是true。</span>

<span class="s2">timeout </span><span class="s5">\#→通过该选项可以覆盖客户指定的IP超时时间。通过该选项可以确保rsync服务器不会永远等待一个崩溃的客户端。超时单位为秒钟，0表示没有超时定义，这也是默认值。对于匿名rsync服务器来说，一个理想的数字是600。</span>

<span class="s1">用配置文件定义目录输出</span>

<span class="s2"> </span><span class="s8">\[root@XueGod64 ~\]# vim /etc/rsyncd.conf //文件不存在，需要自己创建</span>

<span class="s7">【centos6.X 系统上是没有这个文件的，在7系统上，运行来rsync --daemon就会自动生成这个文件】</span>

<a name="OLE_LINK63"></a><a name="OLE_LINK64"></a><a name="OLE_LINK65"><span class="s8">uid </span><span class="s4">=</span><span class="s8"> </span><span class="s8">root</span><span class="s8"> </span><span class="s11">\#运行进程的身份</span></a>

<span class="s8">gid </span><span class="s4">=</span><span class="s8"> root </span><span class="s11">\#运行进程的组</span>

<span class="s8">address </span><span class="s4">=</span><span class="s7">1</span><span class="s12">92</span><span class="s13">.</span><span class="s12">168</span><span class="s13">.0.64</span><span class="s14"> </span><span class="s15">\#监听IP</span>

<span class="s14">port </span><span class="s13">=</span><span class="s12">873</span><span class="s14"> </span><span class="s8"> </span><span class="s11">\#监听端口</span>

<span class="s8">hosts allow </span><span class="s4">=</span><span class="s7">192</span><span class="s4">.</span><span class="s7">168</span><span class="s4">.0.0/24</span><span class="s8"> </span><span class="s11">\#允许同步客户端的IP地址，可以是网段，或者用\*表示所有 192.168.1.0/24或192.168.1.0/255.255.255.0</span>

<span class="s8">use chroot </span><span class="s4">=</span><span class="s8"> yes </span><span class="s11">\#是否囚牢，锁定家目录，rsync被黑之后，黑客无法再rsync运行的家目录之外创建文件，选项设置为yes</span>

<span class="s8">max connections </span><span class="s4">=</span><span class="s7">5</span><span class="s8"> </span><span class="s11">\#最大连接数</span>

<span class="s8">pid file </span><span class="s4">=/</span><span class="s8">var</span><span class="s4">/</span><span class="s8">run</span><span class="s4">/</span><span class="s8">rsyncd.pid </span><span class="s11">\#进程PID，自动生成</span>

<span class="s8">lock file </span><span class="s4">=/</span><span class="s8">var</span><span class="s4">/</span><span class="s8">run</span><span class="s4">/</span><span class="s8">rsync.lock </span><span class="s11">\#指max connectios参数的锁文件</span>

<span class="s8">log file </span><span class="s4">=/</span><span class="s8">var</span><span class="s4">/</span><span class="s8">log</span><span class="s4">/</span><span class="s8">rsyncd.log </span><span class="s11">\#日志文件位置</span>

<span class="s8">motd file </span><span class="s4">=/</span><span class="s8">etc</span><span class="s4">/</span><span class="s8">rsyncd.motd</span>

<span class="s8"> </span><span class="s11">\#客户端登陆之后弹出的消息，需要创建</span>

<span class="s8"> </span>

<span class="s4">\[</span><span class="s8">wwwroot</span><span class="s4">\]</span><span class="s8"> </span><span class="s11">\#共享模块名称</span>

<span class="s8">path </span><span class="s4">=</span><span class="s7">/web-back/</span><span class="s8"> </span><span class="s11">\#路径</span>

<a name="OLE_LINK3"><span class="s8">comment </span><span class="s4">=</span><span class="s8"> used for web-data root </span><span class="s11">\#描述</span></a>

<span class="s10">read</span><span class="s8"> only </span><span class="s4">=</span><span class="s8"> false </span><span class="s11">\#设置服务端文件读写权限</span>

<span class="s8">list </span><span class="s4">=</span><span class="s8"> yes </span><span class="s11">\#是否允许查看模块信息</span>

<span class="s8">auth users </span><span class="s4">=</span><span class="s8"> rsyncuser </span><span class="s11">\#备份的用户，和系统用户无关</span>

<span class="s8">secrets file </span><span class="s4">=/</span><span class="s8">etc</span><span class="s4">/</span><span class="s8">rsync.passwd </span><span class="s11">\#存放用户的密码文件，格式是 用户名：密码</span>

<table class="t1"><tbody><tr class="r1"><td class="td1"><span class="s1">把下面的配置 配置到配置文件里，根据自己的实际IP来修改</span>

<span class="s1">uid = root </span>

<span class="s1">gid = root </span>

<span class="s1">address =192.168. 0.64 </span>

<span class="s1">port =873 </span>

<span class="s1">hosts allow =192.168.0.0/24 </span>

<span class="s1">use chroot = yes </span>

<span class="s1">max connections =5 </span>

<span class="s1">pid file =/var/run/rsyncd.pid </span>

<span class="s1">lock file =/var/run/rsync.lock </span>

<span class="s1">log file =/var/log/rsyncd.log </span>

<span class="s1">motd file =/etc/rsyncd.motd</span>

<span class="s1">\[wwwroot\] </span>

<span class="s1">path =/web-back/ </span>

<span class="s1">comment = used for web-data root </span>

<span class="s1">read only = false </span>

<span class="s1">list = yes </span>

<span class="s1">auth users = rsyncuser </span>

<span class="s1">secrets file = /etc/rsync.passwd</span>

</td></tr></tbody></table><span class="s1">创建提示文件和用户密码</span>

<span class="s2">\[root@XueGod64 ~\]#</span><a name="OLE_LINK66"></a><a name="OLE_LINK67"><span class="s2"> echo "Welcome to Backup Server" > /etc/rsyncd.motd</span></a>

<span class="s2"> \[root@XueGod64 ~\]</span><span class="s7">\# </span><a name="OLE_LINK68"></a><a name="OLE_LINK69"></a><a name="OLE_LINK70"><span class="s7">vim /etc/rsync.passwd</span></a>

<a name="OLE_LINK71"></a><a name="OLE_LINK72"></a><a name="OLE_LINK73"><span class="s7">rsyncuser:password123</span></a>

<span class="s2">\[root@XueGod64 ~\]</span><span class="s7">\#</span><a name="OLE_LINK74"></a><a name="OLE_LINK75"></a><a name="OLE_LINK76"><span class="s7"> </span></a><a name="OLE_LINK77"></a><a name="OLE_LINK78"></a><a name="OLE_LINK79"><span class="s7">chmod 600 /etc/rsync.passwd</span></a><span class="s7"> //目录权</span><span class="s2">限必须是700或者600，否则的话身份验证会失效，设置rsync user的时候</span>

<span class="s7">启动服务测试</span>

<span class="s2"> 启动rsync与xinetd服务</span>

<a name="OLE_LINK80"></a><a name="OLE_LINK81"></a><a name="OLE_LINK93"></a><a name="OLE_LINK94"><span class="s2">systemctl start xinetd </span></a><span class="s2"> #启动xinetd服务</span>

<span class="s2">systemctl enable xinetd #将xinetd服务加入开机项</span>

<a name="OLE_LINK82"></a><a name="OLE_LINK83"></a><a name="OLE_LINK84"></a><a name="OLE_LINK85"><span class="s2">rsync --daemon --config=/etc/rsyncd.conf </span></a><span class="s2">\#加载配置文件rsyncd.conf启动rsync服务</span>

<span class="s2">\[root@xuegod64 ~\]# ps aux|grep rsync</span>

<span class="s2">root 2056 0.0 0.0 114652 316 ? Ss 20:53 0:00 rsync --daemon</span>

<span class="s2"> \[root@xuegod64 ~\]# kill -9 2056</span>

<span class="s6">\[root@xuegod64 ~\]# rsync --daemon --config=/etc/rsyncd.conf</span>

<span class="s2">\[root@xuegod64 ~\]# ps aux|grep rsync</span>

<span class="s2">root 2155 0.0 0.0 114652 520 ? Ss 21:33 0:00 rsync --daemon --config=/etc/rsyncd.conf</span>

<span class="s2">root 2157 0.0 0.0 112660 972 pts/0 S+ 21:33 0:00 grep --color=auto rsync</span>

<span class="s2">\[root@xuegod64 ~\]# netstat -antup | grep :873</span>

<span class="s2">tcp 0 0 192.168.2.164:873 0.0.0.0:\* LISTEN 4252/rsync </span>

<span class="s2">测试，rsync语法： rsync 选项 用户名@备份源服务器IP::共享模块名 目标目录</span>

<span class="s2"> </span><span class="s7"> </span><span class="s2"> \[root@XueGod63 ~\]</span><span class="s7">\# </span><a name="OLE_LINK95"></a><a name="OLE_LINK96"></a><a name="OLE_LINK97"><span class="s7">rsync -avz --delete /var/www/html</span><span class="s7">/ rsy</span><span class="s7">ncuser@192.168.0.64::wwwroot </span></a>

<span class="s2">Welcome to Backup Server</span>

<span class="s2">Password</span><span class="s4">:</span><span class="s2"> </span><span class="s5">\#输入密码password123</span>

<span class="s7">密码处理</span>

<span class="s7">新建一个文件保存好密码，然后在rsync命令中使用--password-file指定此文件即可</span>

<span class="s8">\[root@xuegod63 ~\]# </span><a name="OLE_LINK98"></a><a name="OLE_LINK99"></a><a name="OLE_LINK100"><span class="s8">vim </span><span class="s4">/</span><span class="s8">etc</span><span class="s4">/</span><span class="s8">rsync.passwd </span></a>

<a name="OLE_LINK101"><span class="s8">password123 </span></a>

<span class="s8">\[root@xuegod63 ~\]#</span><a name="OLE_LINK102"></a><a name="OLE_LINK103"></a><a name="OLE_LINK104"><span class="s8"> chmod 600 </span><span class="s4">/</span><span class="s8">etc</span><span class="s4">/</span><span class="s8">rsync.passwd </span></a>

<span class="s8">\[root@xuegod63 ~\]#</span><a name="OLE_LINK105"></a><a name="OLE_LINK106"></a><a name="OLE_LINK107"><span class="s7">rsync -avz --delete /var/www/html rsyncuser@192.168.0.64::wwwroot </span></a><a name="OLE_LINK108"></a><a name="OLE_LINK109"><span class="s7">--password-file</span><span class="s8">=</span><span class="s4">/</span><span class="s8">etc</span><span class="s4">/</span><span class="s8">rsync.passwd</span></a><span class="s8"> </span>

<span class="s7">脚本实现定时自动备份</span>

<span class="s7"> </span><span class="s2"> \[root@xuegod63 ~\]</span><span class="s7">\# vim autobackup.sh</span>

<span class="s7">\#!/bin/bash</span>

<span class="s7">rsync -avz --delete /var/www/html rsyncuser@192.168.0.64::wwwroot </span><span class="s8">--password-file=/opt/passfile </span>

<span class="s2"> \[root@ \[root@xuegod63 ~\]# chmod +x autobackup.sh</span>

<span class="s2">XueGod64 ~\]# rm –rf /web-back/\* //测试脚本</span>

<span class="s2">\[root@xuegod63~\]# sh autobackup.sh</span>

<span class="s2"> \[root@XueGod64 ~\]</span><span class="s7">\# echo "01 3 \* \* \* sh /root/autoback.sh &" >> /var/spool/cron/root</span>

<span class="s8">rsync+sersync实现数据实时同步</span>

<span class="s16">1、​ </span><span class="s17">sersync+rsync原理</span>

<span class="s17">2、inotify和sersync同步的区别</span>

<span class="s18">3、​ </span><span class="s17">配置sersync+rsync实现实时同步</span>

<span class="s17">一台装sersync一台装rsync服务</span>

<span class="s17">Sersync服务器（数据源,源机器）：192.168.0.63</span>

<span class="s17">Rsync服务器（备份端,目标机器）：192.168.0.64</span>

<span class="s17">一、为什么要用rsync+sersync架构？</span>

<span class="s17">1、sersync是基于inotify开发的，类似于inotify-tools的工具</span>

<span class="s17">2、sersync可以记录下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或者某一个目录的名字，然后使用rsync同步的时候，只同步发生变化的文件或者目录</span>

<span class="s17"> </span>

<span class="s17">二、rsync+inotify-tools与rsync+sersync架构的区别？</span>

<span class="s17">1、rsync+inotify-tools</span>

<span class="s17"> a、inotify只能记录下被监听的目录发生了变化（增，删，改）并没有把具体是哪个文件或者哪个目录发生了变化记录下来；</span>

<span class="s17"> b、rsync在同步的时候，并不知道具体是哪个文件或目录发生了变化，每次都是对整个目录进行同步，当数据量很大时，整个目录同步非常耗时（rsync要对整个目录遍历查找对比文件），因此效率很低</span>

<span class="s17"> </span>

<span class="s17">2、rsync+sersync</span>

<span class="s17"> a、sersync可以记录被监听目录中发生变化的（增，删，改）具体某个文件或目录的名字；</span>

<span class="s17"> b、rsync在同步时，只同步发生变化的文件或目录（每次发生变化的数据相对整个同步目录数据来说很小，rsync在遍历查找对比文件时，速度很快），因此效率很高。</span>

<span class="s17">同步过程：</span>

<span class="s17">1. 在同步服务器上开启sersync服务，sersync负责监控配置路径中的文件系统事件变化；</span>

<span class="s17">2. 调用rsync命令把更新的文件同步到目标服务器；</span>

<span class="s17">3. 需要在主服务器配置sersync，在同步目标服务器配置rsync server（注意：是rsync服务）</span>

<span class="s17">同步过程和原理：</span>

<span class="s17">1. 用户实时的往sersync服务器上写入更新文件数据；</span>

<span class="s17">2. 此时需要在同步主服务器上配置sersync服务；</span>

<span class="s17">3. 在另一台服务器开启rsync守护进程服务，以同步拉取来自sersync服务器上的数据；</span>

<span class="s17">通过rsync的守护进程服务后可以发现，实际上sersync就是监控本地的数据写入或更新事件；然后，在调用rsync客户端的命令，将写入或更新事件对应的文件通过rsync推送到目标服务器</span>

<span class="s17">原机器上开始部署sersync服务</span>

<span class="s17">1、下载sersync</span>

<span class="s17">在google code下载sersync的可执行文件版本，里面有配置文件与可执行文件</span>

<span class="s17">wget https://sersync.googlecode.com/files/sersync2.5.4\_64bit\_binary\_stable\_final.tar.gz（有时下载失败，所有要本地留存才行）</span>

<span class="s17">上传到服务器 /opt 目录下</span>

<a name="OLE_LINK110"></a><a name="OLE_LINK111"></a><a name="OLE_LINK112"><span class="s17">tar </span><span class="s17">xvf </span><span class="s17">sersync2.5.4\_64bit\_binary\_stable\_final.tar.gz</span></a>

<span class="s17">mv GNU-Linux-x86 sersync</span>

<span class="s17">2、配置sersync</span>

<span> </span><span class="s17">\[root@xuegod63 sersync\]# cp confxml.xml confxml.xml.bak</span>

<span class="s17">更改优化sersync配置文件：</span>

<span class="s17"> </span><span class="s19">修改24--28行</span>

<span class="s17"><sersync></span>

<span class="s17"> <localpath watch="</span><a name="OLE_LINK113"></a><a name="OLE_LINK114"></a><a name="OLE_LINK115"><span class="s7">/var/www/html</span></a><span class="s17">"> #本地同步目录</span>

<span class="s17"> <remote ip="</span><span class="s7">192.168.0.64</span><span class="s17">" name="</span><span class="s7">wwwroot</span><span class="s17">"/> #rsync模块名称</span>

<span class="s19">修改31--34行，认证部分【rsync密码认证】</span>

<span class="s17"><rsync></span>

<span class="s17"> <commonParams params="-artuz"/></span>

<span class="s17"> <auth start="</span><span class="s7">true</span><span class="s17">" users="rsyncuser" passwordfile="</span><a name="OLE_LINK116"></a><a name="OLE_LINK117"><span class="s7">/etc/rsync.pass</span><span class="s7">wd</span></a><span class="s17">"/></span>

<span class="s17"> <userDefinedPort start="false" port="874"/>\<!-- port=874 --></span>

<span class="s17"> <timeout start="false" time="100"/>\<!-- timeout=100 --></span>

<span class="s17"> <ssh start="false"/></span>

<span class="s17">开启sersync守护进程同步数据</span>

<span class="s17">/root/sersync/</span><a name="OLE_LINK118"></a><a name="OLE_LINK119"><span class="s17">sersync2 -d -r -o </span></a><a name="OLE_LINK120"></a><a name="OLE_LINK121"><span class="s17"> /opt/</span><span class="s17">sersync/confxml.xml</span></a><span class="s17"> </span>

![](http://alibeibei.oss-cn-shanghai.aliyuncs.com/images/ce7ded58-11c0-4cb3-8315-e81d83203206.png)

<span class="s17">测试</span>

<span class="s17">在63 /var/www/html/ 目录 增删改目录文件,</span>

<span class="s17">看64 /web-back 目录的变化</span>

<span class="s17">\[root@xuegod64 web-back\]#</span><a name="OLE_LINK122"><span class="s17"> watch ls -l</span></a>

<span class="s17">设置sersync监控开机自动执行</span>

<span class="s17">vi /etc/rc.d/rc.local #编辑，在最后添加一行</span>

<span class="s17">/usr/local/sersync/sersync2 -d -r -o /usr/local/sersync/confxml.xml ＃设置开机自动运行脚本</span>

<span class="s17">添加脚本监控sersync是否正常运行</span>

<span class="s17">vi /opt/check\_sersync.sh #编辑，添加以下代码</span>

<span class="s17">\#!/bin/sh</span>

<span class="s17">sersync="/opt /sersync/sersync2"</span>

<span class="s17">confxml="/opt /sersync/confxml.xml"</span>

<span class="s17">status=$(ps aux |grep 'sersync2'|grep -v 'grep'|wc -l)</span>

<span class="s17">if \[ $status -eq 0 \];</span>

<span class="s17">then</span>

<span class="s17">$sersync -d -r -o $confxml &</span>

<span class="s17">else</span>

<span class="s17">exit 0;</span>

<span class="s17">fi</span>

<span class="s17">chmod +x /opt /check\_sersync.sh #添加脚本执行权限</span>

<span class="s17">把这个脚本加到任务计划,定期执行检测</span>

<span class="s20">补充： 多实例情况</span>

<span class="s20"> 1、配置多个confxml.xml文件（比如：www、bbs、blog....等等）</span>

<span class="s20"> 2、根据不同的需求同步对应的实例文件</span>

<span class="s17">/usr/local/sersync/sersync2</span><span class="s20"> </span><span class="s17">-d -o /usr/local/sersync/www\_confxml.xml</span>

<span class="s17">/usr/local/sersync/sersync2</span><span class="s20"> </span><span class="s17">-d -o /usr/local/sersync/bbs\_confxml.xml</span>

<span class="s17">3 如果想不同步删除功能，可以修改配置文件，把删除的功能关闭：</span>

![](http://alibeibei.oss-cn-shanghai.aliyuncs.com/images/7f8001d1-1a02-45c0-b835-4b14435dafbe.png)
